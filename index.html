<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go-WASM Stupid Alarm: QR, Solo & Firebase</title>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;

            background-image: url('rick-roll-bg.png'); /* เปลี่ยน 'rick-roll-bg.png' เป็นชื่อไฟล์รูปภาพของคุณ */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            position: relative; 
            z-index: 1; 
        }
        p {
            color: #000000;
            font-size: 1.1em;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }
        .container {
            background-color: rgba(255, 255, 255, 0.9); 
            border: 1px solid #ddd;
            padding: 25px;
            border-radius: 8px;
            max-width: 600px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 90%;
            box-sizing: border-box;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
            text-align: left;
        }
        input[type="text"], textarea, input[type="range"] {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #status {
            margin-top: 20px;
            font-weight: bold;
            color: green;
        }
        .warning {
            color: orange;
            font-size: 0.9em;
            margin-top: 10px;
        }
        .error-message {
            color: red;
            font-weight: bold;
            margin-top: 10px;
        }
        hr {
            margin: 30px 0;
            border: 0;
            border-top: 1px solid #eee;
        }
        .section-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 20px;
        }
        #modeSelection button {
            background-color: #28a745;
        }
        #modeSelection button:hover {
            background-color: #218838;
        }
        #modeSelection button.active {
            background-color: #1a6d2f;
            border: 2px solid #fff;
        }
        #qrcode {
            width: 200px;
            height: 200px;
            margin: 20px auto;
            border: 1px solid #ddd;
        }
        #reader {
            width: 100%;
            max-width: 400px;
            margin: 20px auto;
        }
        #memberList {
            text-align: left;
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
        #memberList ul {
            list-style: none;
            padding: 0;
        }
        #memberList li {
            padding: 5px 0;
            color: #444;
        }
        /* Countdown Page Styles */
        #countdownPage {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            z-index: 1000;
        }
        #countdownTimer {
            font-size: 4em;
            margin: 20px 0;
        }
        #stopAlarmButton {
            background-color: #dc3545; /* Red color for stop */
            padding: 20px 40px;
            font-size: 1.5em;
            border-radius: 10px;
        }
        #stopAlarmButton:hover {
            background-color: #c82333;
        }
    </style>
</head>
<body>
    <h1>Go-WASM Stupid Alarm</h1>
    <p id="welcomeMessage">ยินดีต้อนรับสู่ Stupid Alarm!</p>

    <div class="container" id="initialSetup">
        <div class="section-title">ตั้งค่าเริ่มต้น</div>
        <label for="userNameInput">ชื่อของคุณ:</label>
        <input type="text" id="userNameInput" placeholder="ใส่ชื่อเล่นของคุณ" value="ผู้เล่นกวน">
        <p class="warning">
            ⚠️ ชื่อนี้จะแสดงให้คนในกลุ่มเห็น (ในกรณีที่ใช้โหมดกลุ่ม)
        </p>
        <button id="startAppButton">เริ่มใช้งาน!</button>
        <p id="initialSetupStatus" class="error-message"></p>
    </div>

    <div class="container" id="modeSelection" style="display: none;">
        <div class="section-title">เลือกโหมดการทำงาน</div>
        <p>คุณ **<span id="displayUserName"></span>** ต้องการปลุกแบบไหน?</p>
        <button id="soloModeButton">โหมดเดี่ยว: ปลุกตัวเอง!</button>
        <button id="groupModeButton">โหมดกลุ่ม: ปลุกเพื่อนในกลุ่ม!</button>
        <p class="warning">
            **สำคัญ:** ในโหมดเดี่ยวและโหมดกลุ่ม (ลูกกลุ่ม) คุณอาจต้อง **คลิกปุ่มใดๆ บนหน้าจออีกครั้ง** หลังจากเปลี่ยนโหมด หรือหากเสียงไม่ดัง เพื่อให้เบราว์เซอร์อนุญาตให้เล่นเสียง!
        </p>
    </div>

    <div class="container" id="soloModeControls" style="display: none;">
        <div class="section-title">โหมดเดี่ยว: ปลุกตัวเอง!</div>
        <label for="soloAlarmMessage">ข้อความปลุก (สำหรับคุณ):</label>
        <textarea id="soloAlarmMessage" rows="3" placeholder="ตื่นได้แล้วนะ!"></textarea>

        <label for="soloVolumeRange">ความดัง (0-100%):</label>
        <input type="range" id="soloVolumeRange" min="0" max="100" value="70">
        <span id="soloVolumeValue">70%</span>

        <button id="triggerSoloAlarmButton">ปลุกตัวเองเดี๋ยวนี้!</button>
        <p id="soloStatus" style="font-weight: bold; margin-top: 10px;"></p>
        <button id="backToModeSelectionSolo">กลับไปเลือกโหมด</button>
    </div>

    <div class="container" id="groupModeSetup" style="display: none;">
        <div class="section-title">โหมดกลุ่ม: ตั้งค่ากลุ่ม</div>
        <p>สร้างหรือเข้าร่วมกลุ่มเพื่อปลุกเพื่อน!</p>
        <button id="createGroupModeButton">ฉันคือหัวหน้ากลุ่ม (สร้าง QR)</button>
        <button id="scanGroupModeButton">ฉันคือลูกกลุ่ม (สแกน QR)</button>
        <p>หรือกรอก Group ID ด้วยตัวเอง:</p>
        <input type="text" id="manualGroupIdInput" placeholder="กรอก Group ID ที่นี่">
        <button id="joinGroupManualButton">เข้าร่วมด้วย ID (ลูกกลุ่ม)</button>
        <button id="backToModeSelectionGroupSetup">กลับไปเลือกโหมด</button>
    </div>

    <div class="container" id="groupLeaderControls" style="display: none;">
        <div class="section-title">สำหรับหัวหน้ากลุ่ม (<span id="leaderNameDisplay"></span>)</div>
        <p>Group ID ของคุณคือ: <strong id="displayGroupId"></strong></p>
        <p>ให้เพื่อนสแกน QR Code นี้เพื่อเข้ากลุ่ม:</p>
        <div id="qrcode"></div> <p>หรือบอก Group ID ด้วยตัวเอง: <strong><span id="displayGroupIdText"></span></strong></p>

        <label for="groupAlarmMessage">ข้อความปลุก:</label>
        <textarea id="groupAlarmMessage" rows="3" placeholder="ตื่นได้แล้วไอ้ขี้เซา! สายแล้วนะเพื่อน!"></textarea>

        <label for="groupVolumeRange">ความดัง (0-100%):</label>
        <input type="range" id="groupVolumeRange" min="0" max="100" value="70">
        <span id="groupVolumeValue">70%</span>

        <button id="triggerGroupAlarmButton">ปลุกเพื่อนในกลุ่มเดี๋ยวนี้!</button>
        <button id="backToModeSelectionGroupLeader">กลับไปเลือกโหมด</button>
        <p id="leaderStatus" class="error-message"></p>

        <div id="memberList">
            <h3>สมาชิกในกลุ่ม:</h3>
            <ul id="memberListUl">
                <li>(รอสมาชิกเข้าร่วม)</li>
            </ul>
        </div>
    </div>

    <div class="container" id="groupMemberScan" style="display: none;">
        <div class="section-title">สำหรับลูกกลุ่ม (<span id="memberNameDisplayScan"></span>)</div>
        <p>สแกน QR Code ของหัวหน้ากลุ่มเพื่อเข้าร่วม!</p>
        <div id="reader"></div> <p id="scanStatus" class="error-message"></p>
        <button id="backToModeSelectionGroupScan">กลับไปเลือกโหมด</button>
    </div>

    <div class="container" id="groupMemberStatus" style="display: none;">
        <div class="section-title">คุณได้เข้าร่วมกลุ่มแล้ว! (<span id="memberNameDisplayStatus"></span>)</div>
        <p>Group ID: <strong id="displayJoinedGroupId"></strong></p>
        <p id="alarmReceivedStatus" style="font-weight: bold; color: blue;">กำลังรอคำสั่งปลุก...</p>
        <button id="testSoundButton">ทดสอบเสียง (ถ้าไม่ได้ยิน!)</button>
        <button id="backToModeSelectionGroupMember">กลับไปเลือกโหมด</button>
    </div>

    <div id="countdownPage">
        <p>คุณกำลังจะถูกปลุกโดย <span id="alarmSenderName"></span> ใน</p>
        <div id="countdownTimer">5</div>
        <p>วินาที หากไม่หยุด!</p>
        <button id="stopAlarmButton">หยุดการปลุก!</button>
    </div>

    <script src="wasm_exec.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script>
        // --- YOUR FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAoH02B_trd9RPHxjg24n_skGtRqUCPCvw",
            authDomain: "alarm-sht9.firebaseapp.com",
            databaseURL: "https://alarm-sht9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "alarm-sht9",
            storageBucket: "alarm-sht9.firebasestorage.app",
            messagingSenderId: "127828345964",
            appId: "1:127828345964:web:36e91ece2f692f17fd8449",
            measurementId: "G-2BV3P5MXD8"
        };
        // --- END FIREBASE CONFIGURATION ---

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database(); 
        
        const ALARM_DB_PATH = "stupidAlarms/"; 

        let userName = "ผู้เล่นกวน";
        let currentGroupId = null;
        let goModuleLoaded = false;
        let currentMode = null; 
        let html5QrCodeScanner; 
        let userDeviceId = generateDeviceId(); 

        // --- เพิ่มฟังก์ชัน Base64 Encoding/Decoding ที่รองรับ UTF-8 (ภาษาไทย) ---
        function btoaUTF8(str) {
            return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
                function toSolidBytes(match, p1) {
                    return String.fromCharCode('0x' + p1);
                }));
        }

        function atobUTF8(str) {
            return decodeURIComponent(atob(str).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
        }
        // --- สิ้นสุดฟังก์ชัน Base64 UTF-8 ---


        // UI Elements - Initial Setup
        const initialSetupDiv = document.getElementById('initialSetup');
        const userNameInput = document.getElementById('userNameInput');
        const startAppButton = document.getElementById('startAppButton');
        const welcomeMessage = document.getElementById('welcomeMessage');
        const initialSetupStatus = document.getElementById('initialSetupStatus');

        // UI Elements - Mode Selection
        const modeSelectionDiv = document.getElementById('modeSelection');
        const displayUserName = document.getElementById('displayUserName');
        const soloModeButton = document.getElementById('soloModeButton');
        const groupModeButton = document.getElementById('groupModeButton');

        // UI Elements - Solo Mode
        const soloModeControlsDiv = document.getElementById('soloModeControls');
        const soloAlarmMessageInput = document.getElementById('soloAlarmMessage');
        const soloVolumeRange = document.getElementById('soloVolumeRange');
        const soloVolumeValueSpan = document.getElementById('soloVolumeValue');
        const triggerSoloAlarmButton = document.getElementById('triggerSoloAlarmButton');
        const soloStatus = document.getElementById('soloStatus');
        const backToModeSelectionSoloButton = document.getElementById('backToModeSelectionSolo');

        // UI Elements - Group Mode Setup (New)
        const groupModeSetupDiv = document.getElementById('groupModeSetup');
        const createGroupModeButton = document.getElementById('createGroupModeButton');
        const scanGroupModeButton = document.getElementById('scanGroupModeButton');
        const backToModeSelectionGroupSetupButton = document.getElementById('backToModeSelectionGroupSetup');
        const manualGroupIdInput = document.getElementById('manualGroupIdInput'); 
        const joinGroupManualButton = document.getElementById('joinGroupManualButton'); 

        // UI Elements - Group Leader (New)
        const groupLeaderControlsDiv = document.getElementById('groupLeaderControls');
        const displayGroupId = document.getElementById('displayGroupId');
        const displayGroupIdText = document.getElementById('displayGroupIdText'); 
        const qrcodeDiv = document.getElementById('qrcode');
        const leaderNameDisplay = document.getElementById('leaderNameDisplay');
        const groupAlarmMessageInput = document.getElementById('groupAlarmMessage');
        const groupVolumeRange = document.getElementById('groupVolumeRange');
        const groupVolumeValueSpan = document.getElementById('groupVolumeValue');
        const triggerGroupAlarmButton = document.getElementById('triggerGroupAlarmButton');
        const backToModeSelectionGroupLeaderButton = document.getElementById('backToModeSelectionGroupLeader');
        const leaderStatus = document.getElementById('leaderStatus');
        const memberListUl = document.getElementById('memberListUl'); 

        // UI Elements - Group Member Scan (New)
        const groupMemberScanDiv = document.getElementById('groupMemberScan');
        const memberNameDisplayScan = document.getElementById('memberNameDisplayScan');
        const readerDiv = document.getElementById('reader');
        const scanStatus = document.getElementById('scanStatus');
        const backToModeSelectionGroupScanButton = document.getElementById('backToModeSelectionGroupScan');


        // UI Elements - Group Member Status (Existing, modified)
        const groupMemberStatusDiv = document.getElementById('groupMemberStatus');
        const memberNameDisplayStatus = document.getElementById('memberNameDisplayStatus');
        const displayJoinedGroupId = document.getElementById('displayJoinedGroupId');
        const alarmReceivedStatus = document.getElementById('alarmReceivedStatus');
        const testSoundButton = document.getElementById('testSoundButton'); 
        const backToModeSelectionGroupMemberButton = document.getElementById('backToModeSelectionGroupMember');

        // UI Elements - Countdown Page (New)
        const countdownPageDiv = document.getElementById('countdownPage');
        const alarmSenderNameSpan = document.getElementById('alarmSenderName');
        const countdownTimerDiv = document.getElementById('countdownTimer');
        const stopAlarmButton = document.getElementById('stopAlarmButton');

        let countdownInterval; 
        let currentAlarmData = null; 
        let latestTimestampFromFirebase = 0; // Track the latest timestamp we've seen from Firebase


        // Go-WASM Function (from main.go)
        const speakAlarm = (message, volume) => {
            if (window.speakAlarm && typeof window.speakAlarm === 'function') {
                window.speakAlarm(message, volume);
            } else {
                console.error("Go speakAlarm function not loaded or available.");
                if (currentMode === 'solo') {
                    soloStatus.textContent = "Go-WASM ยังไม่พร้อม! กรุณาเริ่มต้นแอป";
                } else if (currentMode === 'group_member' || currentMode === 'group_leader') { 
                    console.warn("Go-WASM not ready for speaking.");
                }
            }
        };

        // Load Go-WASM Module
        async function loadGoWasm() {
            if (goModuleLoaded) return true;
            initialSetupStatus.textContent = "กำลังโหลด Go-WASM... โปรดรอสักครู่";
            try {
                const go = new Go();
                const result = await WebAssembly.instantiateStreaming(
                    fetch("main.wasm"),
                    go.importObject
                );
                go.run(result.instance);
                goModuleLoaded = true;
                console.log("Go-WASM loaded successfully.");
                initialSetupStatus.textContent = ""; 

                const testUtterance = new SpeechSynthesisUtterance(" ");
                testUtterance.volume = 0; 
                window.speechSynthesis.speak(testUtterance);

                return true;
            } catch (err) {
                console.error("Error loading Go-WASM:", err);
                initialSetupStatus.textContent = `ข้อผิดพลาดในการโหลด Go-WASM: ${err.message}. โปรดตรวจสอบ Console และการรันผ่าน Local Server หรือ GitHub Pages`;
                return false;
            }
        }

        // --- UI Management Functions ---
        function hideAllSections() {
            initialSetupDiv.style.display = 'none';
            modeSelectionDiv.style.display = 'none';
            soloModeControlsDiv.style.display = 'none';
            groupModeSetupDiv.style.display = 'none';
            groupLeaderControlsDiv.style.display = 'none';
            groupMemberScanDiv.style.display = 'none';
            groupMemberStatusDiv.style.display = 'none';
            countdownPageDiv.style.display = 'none'; 
            // Stop QR scanner if it's active
            if (html5QrCodeScanner && html5QrCodeScanner.isScanning) {
                html5QrCodeScanner.stop().then(() => {
                    console.log("QR scanner stopped.");
                }).catch((err) => {
                    if (!err.message.includes("already under transition")) {
                        console.warn("Error stopping QR scanner:", err);
                    } else {
                        console.log("Scanner was already stopping. Ignored redundant stop command.");
                    }
                });
            }
            // Detach Firebase listeners if any
            if (currentGroupId) {
                database.ref(ALARM_DB_PATH + currentGroupId + '/latestAlarm').off('value'); 
                database.ref(ALARM_DB_PATH + currentGroupId + '/members').off('value'); 
                console.log(`Firebase listeners for group ${currentGroupId} detached.`);
            }
            currentGroupId = null; 
            if (countdownInterval) {
                clearInterval(countdownInterval); // Clear any running countdown
                countdownInterval = null;
            }
            window.speechSynthesis.cancel(); // Cancel any ongoing speech
        }

        function showInitialSetup() {
            hideAllSections();
            initialSetupDiv.style.display = 'block';
            welcomeMessage.textContent = "ยินดีต้อนรับสู่ Stupid Alarm!";
            userNameInput.value = localStorage.getItem('userName') || "ผู้เล่นกวน"; 
            initialSetupStatus.textContent = ""; 
            latestTimestampFromFirebase = 0; // Reset timestamp for new session
        }

        function showModeSelection() {
            hideAllSections();
            modeSelectionDiv.style.display = 'block';
            displayUserName.textContent = userName;
            welcomeMessage.textContent = `ยินดีต้อนรับ, ${userName}!`;
            currentGroupId = null; 
            latestTimestampFromFirebase = 0; // Reset timestamp for new session
        }

        function showSoloMode() {
            hideAllSections();
            soloModeControlsDiv.style.display = 'block';
            soloStatus.textContent = ""; 
            currentMode = 'solo';
        }

        function showGroupModeSetup() {
            hideAllSections();
            groupModeSetupDiv.style.display = 'block';
            currentMode = null; 
        }

        async function showGroupLeaderMode() {
            hideAllSections();
            groupLeaderControlsDiv.style.display = 'block';
            leaderNameDisplay.textContent = userName;
            currentMode = 'group_leader';
            leaderStatus.textContent = "";
            currentGroupId = generateGroupId(); 
            displayGroupId.textContent = currentGroupId;
            displayGroupIdText.textContent = currentGroupId; 
            generateQRCode(currentGroupId); 
            
            registerMemberToGroup(currentGroupId, userName, userDeviceId);
            listenForAlarms(currentGroupId); 
            listenForMembers(currentGroupId); 
            latestTimestampFromFirebase = 0; // Reset timestamp for new session
        }

        function showGroupMemberScan() {
            hideAllSections();
            groupMemberScanDiv.style.display = 'block';
            memberNameDisplayScan.textContent = userName;
            scanStatus.textContent = "กำลังเปิดกล้อง...";
            currentMode = 'group_member_scan';
            startQRScanner();
        }

        function showGroupMemberStatus(groupId) {
            hideAllSections();
            groupMemberStatusDiv.style.display = 'block';
            memberNameDisplayStatus.textContent = userName;
            displayJoinedGroupId.textContent = groupId;
            alarmReceivedStatus.textContent = "กำลังรอคำสั่งปลุก...";
            currentGroupId = groupId; 
            currentMode = 'group_member';
            stopQRScanner(); 
            registerMemberToGroup(currentGroupId, userName, userDeviceId);
            listenForAlarms(currentGroupId); 
            latestTimestampFromFirebase = 0; // Reset timestamp for new session
        }

        function showCountdownPage(alarmData) {
            hideAllSections(); 
            countdownPageDiv.style.display = 'flex'; 
            alarmSenderNameSpan.textContent = alarmData.sender;
            countdownTimerDiv.textContent = '5'; 
            currentAlarmData = alarmData; 

            let timeLeft = 5;
            if (countdownInterval) clearInterval(countdownInterval); // Clear any existing countdown
            countdownInterval = setInterval(() => {
                timeLeft--;
                countdownTimerDiv.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    triggerFinalAlarm(alarmData); 
                }
            }, 1000); 
        }

        function triggerFinalAlarm(alarmData) {
            if (countdownInterval) clearInterval(countdownInterval); // Ensure interval is cleared
            countdownInterval = null; // Clear ID
            hideAllSections(); 
            showGroupMemberStatus(alarmData.groupId); 
            
            // Check again for TTS readiness
            if (window.speechSynthesis && !window.speechSynthesis.speaking && !window.speechSynthesis.pending) { 
                speakAlarm(alarmData.message.trim(), alarmData.volume); // Trim message here
                alarmReceivedStatus.textContent = `โดนปลุกจาก ${alarmData.sender}: "${alarmData.message}" (Vol: ${(alarmData.volume * 100).toFixed(0)}%)`;
                console.log("Alarm played successfully after countdown.");
            } else {
                console.warn("SpeechSynthesis is busy/pending or not ready to play alarm after countdown.");
                alarmReceivedStatus.textContent = `มีคำสั่งปลุกจาก ${alarmData.sender} แต่ระบบเสียงไม่พร้อม!`;
                // Attempt to resume if paused
                if (window.speechSynthesis && window.speechSynthesis.paused) {
                    window.speechSynthesis.resume();
                    console.log("SpeechSynthesis resumed after countdown.");
                    // Try speaking again after resume
                    setTimeout(() => {
                        if (window.speechSynthesis && !window.speechSynthesis.speaking && !window.speechSynthesis.pending) {
                            speakAlarm(alarmData.message.trim(), alarmData.volume); // Trim message here
                        }
                    }, 100);
                }
            }
        }

        function stopCountdownAlarm() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
                console.log("Alarm stopped by user.");
            }
            hideAllSections(); 
            showGroupMemberStatus(currentAlarmData.groupId); 
            alarmReceivedStatus.textContent = "การปลุกถูกหยุดแล้ว!";
            window.speechSynthesis.cancel(); 
        }


        // --- Utility Functions ---
        function generateDeviceId() {
            let id = localStorage.getItem('userDeviceId');
            if (!id) {
                id = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
                localStorage.setItem('userDeviceId', id);
            }
            return id;
        }

        function generateGroupId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        // --- QR Code Generation & Scanning ---
        function generateQRCode(groupId) {
            qrcodeDiv.innerHTML = ''; 
            const qrDataObj = {
                groupId: groupId,
                leader: userName
            };
            const qrJsonString = JSON.stringify(qrDataObj);
            
            const qrDataBase64 = btoaUTF8(qrJsonString); 
            console.log("Original JSON String for QR:", qrJsonString);
            console.log("Base64 Encoded (UTF-8) QR Data:", qrDataBase64); 

            new QRCode(qrcodeDiv, {
                text: qrDataBase64, 
                width: 200,
                height: 200,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        async function startQRScanner() {
            scanStatus.textContent = "กำลังขออนุญาตใช้กล้อง...";
            html5QrCodeScanner = new Html5Qrcode("reader");
            Html5Qrcode.getCameras().then(async devices => { 
                if (devices && devices.length) {
                    const cameraId = devices.find(device => device.label.toLowerCase().includes('back'))?.id || devices[0].id;
                    scanStatus.textContent = "กล้องพร้อมสแกน...";
                    
                    if (html5QrCodeScanner.isScanning) {
                        try {
                            await html5QrCodeScanner.stop(); 
                            console.log("QR scanner stopped gracefully before new start.");
                        } catch (err) {
                            console.warn("Error stopping previous scan (might be harmless):", err);
                        }
                    }

                    html5QrCodeScanner.start(
                        cameraId, 
                        {
                            fps: 10,    
                            qrbox: {width: 250, height: 250}  
                        },
                        async (decodedText, decodedResult) => { 
                            console.log(`QR Code detected (raw): ${decodedText}`); 
                            try {
                                const decodedFromBase64 = atobUTF8(decodedText.trim()); 
                                console.log("Decoded from Base64 (UTF-8):", decodedFromBase64); 

                                let jsonStartIndex = decodedFromBase64.indexOf('{');
                                let jsonEndIndex = decodedFromBase64.lastIndexOf('}');
                                let finalCleanText = "";

                                if (jsonStartIndex !== -1 && jsonEndIndex !== -1 && jsonEndIndex > jsonStartIndex) {
                                    finalCleanText = decodedFromBase64.substring(jsonStartIndex, jsonEndIndex + 1);
                                } else {
                                    throw new Error("Cannot find valid JSON start/end characters after Base64 decode.");
                                }

                                console.log("Final Cleaned JSON (for parsing):", finalCleanText); 

                                const qrData = JSON.parse(finalCleanText);
                                if (qrData.groupId) {
                                    // Stop scanner immediately after a successful scan and before showing next screen
                                    try {
                                        await html5QrCodeScanner.stop(); 
                                        console.log("QR scanner stopped after successful scan.");
                                    } catch (err) {
                                        console.warn("Error stopping scanner after success (might be harmless):", err);
                                    }
                                    showGroupMemberStatus(qrData.groupId);
                                    scanStatus.textContent = `สแกนสำเร็จ! เข้ากลุ่ม ${qrData.groupId} แล้ว!`;
                                } else {
                                    scanStatus.textContent = "QR Code ไม่ถูกต้อง (ไม่พบ Group ID ในข้อมูล)"; 
                                }
                            } catch (e) {
                                scanStatus.textContent = `QR Code ไม่ถูกต้อง (ข้อมูลเสียหายหรือไม่ใช่รูปแบบที่คาดหวัง: ${e.message})`; 
                                console.error("Invalid QR code data after Base64 decode:", e);
                            }
                        },
                        (errorMessage) => {
                            // onError (e.g. no QR detected) - keep quiet for continuous scanning
                        }
                    ).catch((err) => {
                        scanStatus.textContent = `เกิดข้อผิดพลาดในการเปิดกล้อง: ${err}. โปรดตรวจสอบสิทธิ์การเข้าถึงกล้อง.`;
                        console.error("Error starting QR scanner:", err);
                    });
                } else {
                    scanStatus.textContent = "ไม่พบกล้องในอุปกรณ์นี้";
                }
            }).catch(err => {
                scanStatus.textContent = `ไม่สามารถเข้าถึงกล้องได้: ${err}. โปรดตรวจสอบสิทธิ์การเข้าถึงกล้อง.`;
                console.error("Error getting cameras:", err);
            });
        }

        function stopQRScanner() {
            if (html5QrCodeScanner && html5QrCodeScanner.isScanning) {
                html5QrCodeScanner.stop().then(() => {
                    console.log("QR scanner stopped.");
                }).catch((err) => {
                     if (!err.message.includes("already under transition")) {
                        console.warn("Error stopping QR scanner:", err);
                    } else {
                        console.log("Scanner was already stopping. Ignored redundant stop command.");
                    }
                });
            }
        }


        // --- Firebase Integration ---

        // Register member to Firebase
        function registerMemberToGroup(groupId, name, deviceId) {
            const memberRef = database.ref(`${ALARM_DB_PATH}${groupId}/members/${deviceId}`);
            memberRef.set({
                name: name,
                lastSeen: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                console.log(`Registered ${name} (${deviceId}) to group ${groupId}`);
            }).catch(error => {
                console.error("Failed to register member:", error);
                if (currentMode === 'group_leader') leaderStatus.textContent = `Error: ไม่สามารถลงทะเบียนสมาชิกได้: ${error.message}`;
                else if (currentMode === 'group_member') alarmReceivedStatus.textContent = `Error: ไม่สามารถลงทะเบียนสมาชิกได้: ${error.message}`;
            });

            // Remove member when they disconnect (simple presence system)
            memberRef.onDisconnect().remove();
        }

        // Listen for alarms from Firebase Realtime Database
        function listenForAlarms(groupId) {
            const groupAlarmRef = database.ref(`${ALARM_DB_PATH}${groupId}/latestAlarm`);
            
            groupAlarmRef.off('value'); 
            
            groupAlarmRef.on('value', (snapshot) => {
                const alarmData = snapshot.val();
                
                if (!alarmData) {
                    console.log("No alarm data or alarm was cleared.");
                    return; 
                }

                if (alarmData.sender !== userName) { 
                    if (alarmData.timestamp > latestTimestampFromFirebase) {
                        showCountdownPage(alarmData);
                        // Do NOT update latestTimestampFromFirebase here.
                        // It will be updated *after* the countdown starts, to ensure it doesn't block if the countdown is stopped.
                    } else {
                        console.log("Received old or already processed alarm, ignoring for countdown.");
                    }
                } else {
                    console.log("Alarm sent by this user confirmed via Firebase:", alarmData);
                    if (currentMode === 'group_leader') {
                        // For leader, update timestamp immediately to prevent self-trigger countdown
                        if (alarmData.timestamp > latestTimestampFromFirebase) {
                            latestTimestampFromFirebase = alarmData.timestamp;
                        }
                        leaderStatus.textContent = `สั่งปลุกกลุ่ม "${currentGroupId}" แล้ว! (ส่งโดยคุณ)`;
                    }
                }
            }, (error) => {
                console.error("Firebase listen error (alarm):", error);
                if (currentMode === 'group_leader') {
                    leaderStatus.textContent = "ข้อผิดพลาด Firebase: " + error.message;
                } else if (currentMode === 'group_member') {
                    alarmReceivedStatus.textContent = "ข้อผิดพลาด Firebase: " + error.message;
                }
            });
            console.log(`Firebase alarm listener attached for group ${groupId}`);
        }

        // Listen for members in Firebase
        function listenForMembers(groupId) {
            const groupMembersRef = database.ref(`${ALARM_DB_PATH}${groupId}/members`);
            
            groupMembersRef.off('value'); 
            
            groupMembersRef.on('value', (snapshot) => {
                const members = snapshot.val();
                memberListUl.innerHTML = ''; // Clear current list
                if (members) {
                    Object.keys(members).forEach(memberId => {
                        const member = members[memberId];
                        const li = document.createElement('li');
                        li.textContent = `${member.name} (Online)`; 
                        memberListUl.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.textContent = '(รอสมาชิกเข้าร่วม)';
                    memberListUl.appendChild(li);
                }
                console.log("Members updated:", members);
            }, (error) => {
                console.error("Firebase listen error (members):", error);
                if (currentMode === 'group_leader') {
                    leaderStatus.textContent = `ข้อผิดพลาดในการดึงรายชื่อสมาชิก: ${error.message}`;
                }
            });
            console.log(`Firebase members listener attached for group ${groupId}`);
        }


        // --- Event Listeners ---

        // Initial Setup
        startAppButton.addEventListener('click', async () => {
            userName = userNameInput.value.trim();
            if (!userName) userName = "ผู้เล่นกวน";
            localStorage.setItem('userName', userName); 
            initialSetupStatus.textContent = "กำลังโหลด Go-WASM... โปรดรอสักครู่";
            const loaded = await loadGoWasm();
            if (loaded) {
                showModeSelection();
            } else {
                initialSetupStatus.textContent = "ไม่สามารถโหลด Go-WASM ได้! โปรดตรวจสอบ Console และการรันผ่าน Local Server หรือ GitHub Pages";
            }
        });

        // Mode Selection
        soloModeButton.addEventListener('click', showSoloMode);
        groupModeButton.addEventListener('click', showGroupModeSetup);

        // Solo Mode
        soloVolumeRange.addEventListener('input', () => {
            soloVolumeValueSpan.textContent = `${soloVolumeRange.value}%`;
        });
        triggerSoloAlarmButton.addEventListener('click', () => {
            const message = soloAlarmMessageInput.value || "ตื่นได้แล้วนะ!";
            const volume = parseFloat(soloVolumeRange.value) / 100;
            
            if (window.speechSynthesis && !window.speechSynthesis.speaking && !window.speechSynthesis.pending) { 
                speakAlarm(message.trim(), volume); // Trim message here
                soloStatus.textContent = `ปลุกตัวเองแล้ว: "${message}" (Vol: ${(volume * 100).toFixed(0)}%)`;
            } else {
                soloStatus.textContent = "ระบบเสียงไม่พร้อม หรือกำลังพูดอยู่! กรุณาลองใหม่.";
                console.warn("SpeechSynthesis not ready or busy for solo alarm.");
            }
        });
        backToModeSelectionSoloButton.addEventListener('click', showModeSelection);

        // Group Mode Setup (New buttons)
        createGroupModeButton.addEventListener('click', showGroupLeaderMode);
        scanGroupModeButton.addEventListener('click', showGroupMemberScan);
        backToModeSelectionGroupSetupButton.addEventListener('click', showModeSelection);
        
        // Manual Group ID Join Button
        joinGroupManualButton.addEventListener('click', () => {
            const manualId = manualGroupIdInput.value.trim();
            if (manualId) {
                showGroupMemberStatus(manualId);
            } else {
                alert("กรุณากรอก Group ID ด้วยตนเอง");
            }
        });


        // Group Leader Controls
        groupVolumeRange.addEventListener('input', () => {
            groupVolumeValueSpan.textContent = `${groupVolumeRange.value}%`;
        });
        triggerGroupAlarmButton.addEventListener('click', () => {
            if (!currentGroupId) {
                leaderStatus.textContent = "ยังไม่ได้สร้าง Group ID!";
                return;
            }

            const message = groupAlarmMessageInput.value || "ตื่นได้แล้วไอ้ขี้เซา! สายแล้วนะเพื่อน!!";
            const volume = parseFloat(groupVolumeRange.value) / 100;

            const alarmData = {
                message: message.trim(), // Trim message here
                volume: volume,
                timestamp: firebase.database.ServerValue.TIMESTAMP, 
                sender: userName 
            };

            // Send alarm to Firebase
            database.ref(ALARM_DB_PATH + currentGroupId + '/latestAlarm').set(alarmData) // Use SET instead of PUSH to update the same node
                .then(() => {
                    console.log("Alarm sent to Firebase:", alarmData);
                })
                .catch((error) => {
                    leaderStatus.textContent = "ข้อผิดพลาดในการสั่งปลุก: " + error.message;
                    console.error("Error sending alarm to Firebase:", error);
                });
        });
        backToModeSelectionGroupLeaderButton.addEventListener('click', showModeSelection);

        // Group Member Scan
        backToModeSelectionGroupScanButton.addEventListener('click', showModeSelection);

        // Group Member Status
        testSoundButton.addEventListener('click', () => {
            if (window.speechSynthesis && !window.speechSynthesis.speaking && !window.speechSynthesis.pending) {
                speakAlarm("ทดสอบเสียง", 1);
                alarmReceivedStatus.textContent = "ทดสอบเสียง: ดังแล้ว!";
            } else {
                alarmReceivedStatus.textContent = "ทดสอบเสียง: ระบบเสียงไม่พร้อม! คลิกอีกครั้ง หรือตรวจสอบ Console.";
            }
        });
        backToModeSelectionGroupMemberButton.addEventListener('click', showModeSelection);

        // Countdown Page Button
        stopAlarmButton.addEventListener('click', stopCountdownAlarm);

        // Initial Load: Show setup screen
        document.addEventListener('DOMContentLoaded', showInitialSetup);

        // Auto-join from URL (if needed for quick demo setup) - Handle with care
        const urlParams = new URLSearchParams(window.location.search);
        const initialGroupId = urlParams.get('groupId');
        const initialRole = urlParams.get('role'); 
        const initialName = urlParams.get('name');

        if (initialName) {
            userNameInput.value = initialName;
        }

        if (initialGroupId && (initialRole === 'leader' || initialRole === 'member')) {
            setTimeout(() => {
                startAppButton.click(); 
                setTimeout(() => { 
                    if (initialRole === 'leader') {
                        showGroupLeaderMode(); 
                        displayGroupId.textContent = initialGroupId; 
                        displayGroupIdText.textContent = initialGroupId;
                        generateQRCode(initialGroupId); 
                    } else { 
                        showGroupMemberStatus(initialGroupId); 
                    }
                }, 500); 
            }, 100);
        }
    </script>
</body>
</html>
